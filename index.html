<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SD M√ìVEIS - Sistema Pro v2.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --gold: #D4AF37; --bg: #F3F4F6; --white: #ffffff; 
            --text-main: #111827; --text-sub: #6B7280; --accent: #3B82F6; 
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --sidebar-width: 250px;
        }
        
        * { box-sizing: border-box; }
        body { 
            margin: 0; 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            display: flex; 
            height: 100vh; 
            background: var(--bg); 
            color: var(--text-main); 
            overflow: hidden; 
        }

        /* LOGIN */
        #login-overlay { 
            position: fixed; 
            inset: 0; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 1000; 
        }
        .login-box { 
            background: var(--white); 
            padding: 2.5rem; 
            border-radius: 1.5rem; 
            width: 90%;
            max-width: 380px; 
            text-align: center; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        /* MOBILE HEADER */
        #mobile-header {
            display: none;
            background: var(--white);
            padding: 1rem;
            border-bottom: 1px solid #E5E7EB;
            align-items: center;
            justify-content: space-between;
        }
        #menu-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* SIDEBAR */
        #sidebar { 
            width: var(--sidebar-width); 
            background: var(--white); 
            border-right: 1px solid #E5E7EB; 
            display: flex; 
            flex-direction: column; 
            padding: 1.5rem 0.75rem; 
            transition: transform 0.3s ease;
            position: relative;
            z-index: 100;
        }
        
        .nav-btn { 
            width: 100%; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding: 12px;
            border: none; 
            background: none; 
            color: var(--text-sub); 
            border-radius: 0.5rem;
            cursor: pointer; 
            font-size: 0.9rem; 
            font-weight: 500; 
            margin-bottom: 4px;
            transition: all 0.2s;
            text-align: left;
        }
        .nav-btn:hover { background: #F3F4F6; }
        .nav-btn.active { background: #EFF6FF; color: var(--accent); font-weight: 600; }

        /* MAIN CONTENT */
        #main { 
            flex: 1; 
            overflow-y: auto; 
            display: none; 
            padding: 2rem; 
        }
        
        .page-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 1.5rem; 
            flex-wrap: wrap;
            gap: 1rem;
        }
        .page-header h1 { margin: 0; font-size: 1.75rem; }
        
        /* NOTIFICA√á√ïES */
        #notif-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }
        .notif {
            background: var(--white);
            padding: 1rem 1.25rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            border-left: 4px solid var(--warning);
            animation: slideIn 0.3s ease;
            display: flex;
            gap: 12px;
            align-items: start;
        }
        .notif.danger { border-left-color: var(--danger); }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* GRIDS */
        .collection-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
        }
        
        .card { 
            background: var(--white); 
            border-radius: 1rem; 
            border: 1px solid #E5E7EB; 
            overflow: hidden; 
            padding: 1.25rem; 
            position: relative; 
            transition: box-shadow 0.2s;
        }
        .card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        /* DASHBOARD */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: linear-gradient(135deg, var(--accent) 0%, #2563eb 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .stat-card h3 { margin: 0 0 0.5rem; font-size: 0.875rem; opacity: 0.9; }
        .stat-card .value { font-size: 2rem; font-weight: bold; margin: 0; }
        .stat-card.success { background: linear-gradient(135deg, var(--success) 0%, #059669 100%); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
        .stat-card.warning { background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%); box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3); }
        .stat-card.gold { background: linear-gradient(135deg, var(--gold) 0%, #b8941f 100%); box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3); }

        .chart-container {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 1rem;
            border: 1px solid #E5E7EB;
            margin-bottom: 1.5rem;
        }
        .chart-container h3 { margin-top: 0; color: var(--text-sub); font-size: 0.875rem; text-transform: uppercase; }

        /* WORKFLOW & PROGRESSO */
        .progress-bg { 
            width: 100%; 
            background: #E5E7EB; 
            height: 8px; 
            border-radius: 10px; 
            margin: 12px 0; 
            overflow: hidden; 
        }
        .progress-fill { 
            background: linear-gradient(90deg, var(--gold) 0%, #f0c674 100%);
            height: 100%; 
            transition: width 0.5s ease; 
            border-radius: 10px;
        }
        
        .checklist { 
            display: flex; 
            gap: 8px; 
            margin-top: 10px; 
            font-size: 11px; 
            background: #F9FAFB; 
            padding: 8px; 
            border-radius: 8px; 
            flex-wrap: wrap;
        }
        .checklist label { display: flex; align-items: center; gap: 4px; cursor: pointer; }

        /* CLIENTES */
        .cliente-card {
            background: var(--white);
            border: 1px solid #E5E7EB;
            border-radius: 1rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }
        .cliente-card:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer; }
        .cliente-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        .cliente-info h3 { margin: 0 0 0.25rem; }
        .cliente-info .meta { font-size: 0.75rem; color: var(--text-sub); }
        .cliente-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #E5E7EB;
        }
        .cliente-stat { text-align: center; }
        .cliente-stat .label { font-size: 0.7rem; color: var(--text-sub); text-transform: uppercase; }
        .cliente-stat .value { font-size: 1.25rem; font-weight: bold; color: var(--accent); }

        /* MANUAL LIST */
        .manual-list { 
            display: flex; 
            flex-direction: column; 
            gap: 1px; 
            background: #E5E7EB; 
            border-radius: 0.75rem; 
            overflow: hidden; 
        }
        .manual-item { 
            background: var(--white); 
            padding: 1.2rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer; 
            gap: 1rem;
        }
        .manual-info { flex: 1; }
        .manual-info span { 
            color: var(--accent); 
            font-size: 0.7rem; 
            font-weight: 700; 
            text-transform: uppercase; 
            display: block; 
        }

        /* CONTRATO */
        .contrato-preview {
            background: white;
            padding: 2rem;
            border: 2px solid #E5E7EB;
            border-radius: 0.5rem;
            font-family: 'Times New Roman', serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 1rem auto;
        }
        .contrato-header {
            text-align: center;
            border-bottom: 2px solid var(--gold);
            padding-bottom: 1rem;
            margin-bottom: 2rem;
        }
        .contrato-section {
            margin-bottom: 1.5rem;
        }
        .contrato-section h3 {
            color: var(--gold);
            font-size: 1rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }
        .assinatura-box {
            margin-top: 3rem;
            padding-top: 1rem;
            border-top: 2px solid #E5E7EB;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            text-align: center;
        }
        .assinatura-line {
            border-top: 1px solid #000;
            margin-top: 3rem;
            padding-top: 0.5rem;
        }

        /* BOT√ïES */
        .btn-add { 
            background: var(--accent); 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 0.75rem; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-add:hover { background: #2563eb; transform: translateY(-1px); }
        
        .btn-outline { 
            background: none; 
            border: 1px solid #ddd; 
            padding: 6px 12px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 11px; 
            transition: all 0.2s;
        }
        .btn-outline:hover { background: #F3F4F6; }
        
        input, textarea, select { 
            width: 100%; 
            padding: 10px; 
            margin-top: 5px; 
            border: 1px solid #E5E7EB; 
            border-radius: 8px; 
            font-family: inherit;
            font-size: 0.9rem;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* BADGES */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge.success { background: #d1fae5; color: #065f46; }
        .badge.warning { background: #fef3c7; color: #92400e; }
        .badge.danger { background: #fee2e2; color: #991b1b; }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 500;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-sub);
        }

        /* RESPONSIVIDADE */
        @media (max-width: 768px) {
            #mobile-header { display: flex; }
            
            #sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
                z-index: 200;
            }
            #sidebar.open { transform: translateX(0); }
            
            #main { 
                padding: 1rem; 
                width: 100%;
            }
            
            .page-header { 
                flex-direction: column; 
                align-items: stretch; 
            }
            
            .collection-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            #notif-container {
                left: 1rem;
                right: 1rem;
                max-width: none;
            }

            .assinatura-box {
                grid-template-columns: 1fr;
            }

            .contrato-preview {
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .page-header h1 { font-size: 1.5rem; }
            .stat-card .value { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

<!-- LOGIN -->
<div id="login-overlay">
    <div class="login-box">
        <img src="logo-sd.jpeg" style="width: 120px; margin-bottom: 1.5rem; border-radius: 50%;">
        <h2 style="margin: 0 0 0.5rem;">SD M√≥veis Pro</h2>
        <p style="color: var(--text-sub); font-size: 0.875rem; margin-bottom: 1.5rem;">Sistema Integrado v2.0</p>
        <input type="password" id="senha" placeholder="Digite sua senha" style="margin-bottom: 1rem;">
        <button class="btn-add" style="width:100%;" onclick="logar()">üîê Entrar</button>
    </div>
</div>

<!-- MOBILE HEADER -->
<div id="mobile-header">
    <button id="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
    <img src="logo-sd.jpeg" style="height: 40px; border-radius: 50%;" alt="SD">
    <div style="width: 24px;"></div>
</div>

<!-- SIDEBAR -->
<nav id="sidebar">
    <div style="text-align: center; padding-bottom: 20px; border-bottom: 1px solid #E5E7EB; margin-bottom: 1rem;">
        <img src="logo-sd.jpeg" style="width: 80px; height: 80px; border-radius: 50%; margin-bottom: 0.75rem; object-fit: cover;">
        <strong style="font-size: 1.1rem;">SD M√≥veis</strong>
    </div>
    
    <button onclick="showTab('dashboard')" class="nav-btn active">üìä Dashboard</button>
    <button onclick="showTab('projetos')" class="nav-btn">üìã Produ√ß√£o</button>
    <button onclick="showTab('clientes')" class="nav-btn">üë• Clientes</button>
    <button onclick="showTab('contratos')" class="nav-btn">üìÑ Contratos</button>
    <button onclick="showTab('portfolio')" class="nav-btn">üñºÔ∏è Portf√≥lio</button>
    <button onclick="showTab('manual')" class="nav-btn">üìñ Manual</button>
    <button onclick="showTab('financeiro')" class="nav-btn">üí∞ Financeiro</button>
    <button onclick="showTab('assistente')" class="nav-btn">üõ†Ô∏è Ferramentas</button>
    
    <div style="margin-top: auto; border-top: 1px solid #E5E7EB; padding-top: 1rem;">
        <button onclick="exportarBackup()" class="nav-btn">üíæ Backup</button>
        <button onclick="location.reload()" class="nav-btn" style="color: var(--danger);">üö™ Sair</button>
    </div>
</nav>

<!-- NOTIFICA√á√ïES -->
<div id="notif-container"></div>

<!-- MAIN CONTENT -->
<main id="main">
    <!-- DASHBOARD -->
    <section id="dashboard" class="tab-content active">
        <div class="page-header">
            <h1>üìä Dashboard Geral</h1>
        </div>
        
        <div class="dashboard-grid">
            <div class="stat-card">
                <h3>Projetos Ativos</h3>
                <p class="value" id="stat-projetos">0</p>
            </div>
            <div class="stat-card success">
                <h3>Faturamento Total</h3>
                <p class="value" id="stat-faturamento">R$ 0</p>
            </div>
            <div class="stat-card warning">
                <h3>Prazos Pr√≥ximos</h3>
                <p class="value" id="stat-prazos">0</p>
            </div>
            <div class="stat-card gold">
                <h3>Total Clientes</h3>
                <p class="value" id="stat-clientes">0</p>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
            <div class="chart-container">
                <h3>Progresso M√©dio dos Projetos</h3>
                <canvas id="chartProgresso"></canvas>
            </div>
            <div class="chart-container">
                <h3>Faturamento Mensal</h3>
                <canvas id="chartFaturamento"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h3>Status dos Projetos</h3>
            <canvas id="chartStatus" style="max-height: 300px;"></canvas>
        </div>
    </section>

    <!-- PRODU√á√ÉO -->
    <section id="projetos" class="tab-content" style="display:none">
        <div class="page-header">
            <h1>üìã Produ√ß√£o Ativa</h1>
            <button class="btn-add" onclick="addProjeto()">+ Novo Projeto</button>
        </div>
        <div id="lista-projects" class="collection-grid"></div>
    </section>

    <!-- CLIENTES -->
    <section id="clientes" class="tab-content" style="display:none">
        <div class="page-header">
            <h1>üë• Gest√£o de Clientes</h1>
            <button class="btn-add" onclick="addCliente()">+ Novo Cliente</button>
        </div>
        <div id="lista-clientes"></div>
    </section>

    <!-- CONTRATOS -->
    <section id="contratos" class="tab-content" style="display:none">
        <div class="page-header">
            <h1>üìÑ Gerador de Contratos</h1>
        </div>
        
        <div class="card" style="max-width: 600px; margin-bottom: 2rem;">
            <h3>Dados do Contrato</h3>
            <div style="display: grid; gap: 1rem; margin-top: 1rem;">
                <div>
                    <label><strong>Cliente</strong></label>
                    <select id="contrato-cliente">
                        <option value="">Selecione um cliente</option>
                    </select>
                </div>
                <div>
                    <label><strong>Servi√ßo/Projeto</strong></label>
                    <textarea id="contrato-servico" rows="3" placeholder="Descri√ß√£o detalhada do servi√ßo..."></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label><strong>Valor Total (R$)</strong></label>
                        <input type="number" id="contrato-valor" placeholder="0.00">
                    </div>
                    <div>
                        <label><strong>Data de Entrega</strong></label>
                        <input type="date" id="contrato-entrega">
                    </div>
                </div>
                <div>
                    <label><strong>Forma de Pagamento</strong></label>
                    <input type="text" id="contrato-pagamento" placeholder="Ex: 50% entrada + 50% na entrega">
                </div>
                <div>
                    <label><strong>Observa√ß√µes Adicionais</strong></label>
                    <textarea id="contrato-obs" rows="2" placeholder="Garantia, condi√ß√µes especiais..."></textarea>
                </div>
            </div>
            <button class="btn-add" style="width: 100%; margin-top: 1.5rem;" onclick="visualizarContrato()">üëÅÔ∏è Visualizar Contrato</button>
        </div>

        <div id="contrato-view" style="display: none;">
            <div style="text-align: right; margin-bottom: 1rem;">
                <button class="btn-add" onclick="gerarContratosPDF()">üì• Baixar PDF</button>
            </div>
            <div id="contrato-content"></div>
        </div>
    </section>

    <!-- PORTF√ìLIO -->
    <section id="portfolio" class="tab-content" style="display:none">
        <div class="page-header">
            <h1>üñºÔ∏è Portf√≥lio</h1>
            <button class="btn-add" onclick="addItem('portfolio')">+ Add Foto</button>
        </div>
        <div id="grid-portfolio" class="collection-grid"></div>
    </section>

    <!-- MANUAL -->
    <section id="manual" class="tab-content" style="display:none">
        <div class="page-header">
            <h1>üìñ Manual e Garantia</h1>
            <button class="btn-add" onclick="addItem('manual')">+ Novo Guia</button>
        </div>
        <div id="lista-manual" class="manual-list"></div>
    </section>

    <!-- FINANCEIRO -->
    <section id="financeiro" class="tab-content" style="display:none">
        <div class="page-header"><h1>üí∞ Financeiro</h1></div>
        <div class="collection-grid">
            <div class="card" style="border-left: 5px solid var(--success);">
                <h3>Total em Contratos</h3>
                <h2 id="total-vendas">R$ 0,00</h2>
                <p style="font-size: 0.875rem; color: var(--text-sub); margin-top: 0.5rem;">Baseado em projetos ativos</p>
            </div>
            <div class="card">
                <h3>üìù Gerador de Or√ßamento</h3>
                <input type="text" id="orc-cliente" placeholder="Nome do Cliente">
                <textarea id="orc-itens" placeholder="Itens do or√ßamento..." rows="3"></textarea>
                <input type="number" id="orc-valor" placeholder="Valor R$">
                <button class="btn-add" style="width:100%; background:#25D366; margin-top:10px;" onclick="gerarOrcamento()">üìã Copiar p/ WhatsApp</button>
            </div>
        </div>
    </section>

    <!-- ASSISTENTE -->
    <section id="assistente" class="tab-content" style="display:none">
        <div class="page-header"><h1>üõ†Ô∏è Assistente T√©cnico</h1></div>
        <div class="card" style="max-width: 400px;">
            <h3>üìè Calculadora de MDF</h3>
            <p style="color: var(--text-sub); font-size: 0.875rem;">Quantos metros lineares de m√≥vel?</p>
            <input type="number" id="m-calc" oninput="calcMDF()" placeholder="Ex: 10">
            <h4 id="res-mdf" style="color:var(--gold); margin-top:15px;"></h4>
        </div>
    </section>
</main>

<!-- MODAL CLIENTE -->
<div id="modalCliente" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Detalhes do Cliente</h2>
            <button class="modal-close" onclick="closeModal('modalCliente')">√ó</button>
        </div>
        <div id="cliente-detalhes"></div>
    </div>
</div>

<script>
    const { jsPDF } = window.jspdf;
    let charts = {};

    // DATABASE
    let db = JSON.parse(localStorage.getItem('sd_final_db')) || { 
        clientes: [], 
        projetos: [], 
        portfolio: [], 
        manual: [] 
    };

    // AUDIO PARA NOTIFICA√á√ÉO
    const beep = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE=');

    // LOGIN
    function logar() {
        if(document.getElementById('senha').value === "123") {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main').style.display = 'block';
            render();
            initCharts();
            checkNotificacoes();
            setInterval(checkNotificacoes, 60000);
        } else {
            alert("‚ùå Senha incorreta!");
        }
    }

    // MENU MOBILE
    function toggleMenu() {
        document.getElementById('sidebar').classList.toggle('open');
    }

    // NAVEGA√á√ÉO
    function showTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).style.display = 'block';
        event.currentTarget.classList.add('active');
        
        if(window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.remove('open');
        }
        
        if(id === 'dashboard') {
            updateCharts();
        }
        
        if(id === 'contratos') {
            popularSelectClientes();
        }
    }

    // SAVE
    function save() {
        localStorage.setItem('sd_final_db', JSON.stringify(db));
        render();
        updateCharts();
        checkNotificacoes();
    }

    // NOTIFICA√á√ïES
    function showNotif(msg, tipo = 'warning') {
        const notif = document.createElement('div');
        notif.className = `notif ${tipo}`;
        notif.innerHTML = `
            <div style="font-size: 1.5rem;">${tipo === 'danger' ? 'üö®' : '‚ö†Ô∏è'}</div>
            <div>
                <strong>${tipo === 'danger' ? 'URGENTE!' : 'Aten√ß√£o'}</strong>
                <p style="margin: 0.25rem 0 0; font-size: 0.875rem;">${msg}</p>
            </div>
        `;
        document.getElementById('notif-container').appendChild(notif);
        beep.play().catch(() => {});
        
        setTimeout(() => {
            notif.style.opacity = '0';
            setTimeout(() => notif.remove(), 300);
        }, 5000);
    }

    function checkNotificacoes() {
        const hoje = new Date();
        db.projetos.forEach(p => {
            if(!p.prazo) return;
            const prazo = new Date(p.prazo);
            const diff = (prazo - hoje) / (1000*60*60*24);
            
            if(diff < 0 && !p.notificadoAtrasado) {
                showNotif(`Projeto "${p.cliente}" est√° ATRASADO!`, 'danger');
                p.notificadoAtrasado = true;
                save();
            } else if(diff >= 0 && diff < 3 && !p.notificado3dias) {
                showNotif(`Projeto "${p.cliente}" vence em ${Math.ceil(diff)} dias!`);
                p.notificado3dias = true;
                save();
            }
        });
    }

    // PROJETOS
    function addProjeto() {
        const cliente = prompt("Nome do Cliente:");
        if(!cliente) return;
        
        const servico = prompt("Servi√ßo:");
        const valor = parseFloat(prompt("Valor R$:")) || 0;
        const prazo = prompt("Data Entrega (AAAA-MM-DD):");
        
        db.projetos.push({
            cliente, 
            servico, 
            valor, 
            prazo, 
            progresso: 10, 
            check: [false, false, false],
            criado: new Date().toISOString()
        });
        save();
    }

    function calcPrazoCor(data) {
        if(!data) return 'var(--gold)';
        const diff = (new Date(data) - new Date()) / (1000*60*60*24);
        if(diff < 0) return 'var(--danger)';
        if(diff < 7) return 'var(--warning)';
        return 'var(--success)';
    }

    function getPrazoStatus(data) {
        if(!data) return '';
        const diff = (new Date(data) - new Date()) / (1000*60*60*24);
        if(diff < 0) return '<span class="badge danger">ATRASADO</span>';
        if(diff < 3) return '<span class="badge warning">URGENTE</span>';
        if(diff < 7) return '<span class="badge warning">Pr√≥ximo</span>';
        return '<span class="badge success">No Prazo</span>';
    }

    // CLIENTES
    function addCliente() {
        const nome = prompt("Nome do Cliente:");
        if(!nome) return;
        
        const cpf = prompt("CPF/CNPJ:");
        const tel = prompt("Telefone:");
        const email = prompt("Email:");
        const endereco = prompt("Endere√ßo completo:");
        
        db.clientes.push({
            nome,
            cpf,
            tel,
            email,
            endereco,
            projetos: [],
            notas: '',
            criado: new Date().toISOString()
        });
        save();
    }

    function verCliente(idx) {
        const c = db.clientes[idx];
        const projetosCliente = db.projetos.filter(p => p.cliente === c.nome);
        const totalGasto = projetosCliente.reduce((acc, p) => acc + p.valor, 0);
        
        document.getElementById('cliente-detalhes').innerHTML = `
            <div style="margin-bottom: 1.5rem;">
                <h3 style="margin: 0 0 1rem;">${c.nome}</h3>
                <div style="display: grid; gap: 0.75rem;">
                    <div><strong>üìã CPF/CNPJ:</strong> ${c.cpf || 'N√£o informado'}</div>
                    <div><strong>üìû Telefone:</strong> ${c.tel || 'N√£o informado'}</div>
                    <div><strong>üìß Email:</strong> ${c.email || 'N√£o informado'}</div>
                    <div><strong>üìç Endere√ßo:</strong> ${c.endereco || 'N√£o informado'}</div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                <div style="background: #EFF6FF; padding: 1rem; border-radius: 0.5rem; text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--text-sub);">PROJETOS</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent);">${projetosCliente.length}</div>
                </div>
                <div style="background: #ECFDF5; padding: 1rem; border-radius: 0.5rem; text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--text-sub);">TOTAL GASTO</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--success);">R$ ${totalGasto.toLocaleString('pt-BR')}</div>
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <strong>üìù Notas Internas:</strong>
                <textarea id="cliente-notas" rows="4" style="margin-top: 0.5rem;">${c.notas || ''}</textarea>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <strong>üóÇÔ∏è Hist√≥rico de Projetos:</strong>
                ${projetosCliente.length ? projetosCliente.map(p => `
                    <div style="background: #F9FAFB; padding: 0.75rem; border-radius: 0.5rem; margin-top: 0.5rem;">
                        <div style="display: flex; justify-content: space-between;">
                            <strong>${p.servico}</strong>
                            <span style="color: var(--success);">R$ ${p.valor.toLocaleString('pt-BR')}</span>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-sub); margin-top: 0.25rem;">
                            Entrega: ${p.prazo || 'N√£o definida'} ‚Ä¢ Progresso: ${p.progresso}%
                        </div>
                    </div>
                `).join('') : '<p style="color: var(--text-sub); font-size: 0.875rem; margin-top: 0.5rem;">Nenhum projeto ainda</p>'}
            </div>
            
            <button class="btn-add" style="width: 100%;" onclick="salvarNotasCliente(${idx})">üíæ Salvar Notas</button>
        `;
        
        document.getElementById('modalCliente').classList.add('active');
    }

    function salvarNotasCliente(idx) {
        db.clientes[idx].notas = document.getElementById('cliente-notas').value;
        save();
        alert("‚úÖ Notas salvas!");
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    // CONTRATOS
    function popularSelectClientes() {
        const select = document.getElementById('contrato-cliente');
        select.innerHTML = '<option value="">Selecione um cliente</option>' + 
            db.clientes.map((c, i) => `<option value="${i}">${c.nome}</option>`).join('');
    }

    function visualizarContrato() {
        const clienteIdx = document.getElementById('contrato-cliente').value;
        if(!clienteIdx) {
            alert("‚ö†Ô∏è Selecione um cliente!");
            return;
        }
        
        const cliente = db.clientes[clienteIdx];
        const servico = document.getElementById('contrato-servico').value;
        const valor = parseFloat(document.getElementById('contrato-valor').value) || 0;
        const entrega = document.getElementById('contrato-entrega').value;
        const pagamento = document.getElementById('contrato-pagamento').value;
        const obs = document.getElementById('contrato-obs').value;
        
        if(!servico || !valor) {
            alert("‚ö†Ô∏è Preencha servi√ßo e valor!");
            return;
        }
        
        const hoje = new Date().toLocaleDateString('pt-BR');
        
        document.getElementById('contrato-content').innerHTML = `
            <div class="contrato-preview">
                <div class="contrato-header">
                    <img src="logo-sd.jpeg" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%; margin-bottom: 1rem;">
                    <h2 style="margin: 0; color: var(--gold);">SD M√ìVEIS</h2>
                    <p style="margin: 0.25rem 0 0; color: var(--text-sub);">CONTRATO DE PRESTA√á√ÉO DE SERVI√áOS</p>
                </div>

                <div class="contrato-section">
                    <h3>1. Partes Contratantes</h3>
                    <p><strong>CONTRATADA:</strong> SD M√ìVEIS, empresa especializada em fabrica√ß√£o e instala√ß√£o de m√≥veis planejados.</p>
                    <p><strong>CONTRATANTE:</strong> ${cliente.nome}<br>
                    CPF/CNPJ: ${cliente.cpf || 'N√£o informado'}<br>
                    Endere√ßo: ${cliente.endereco || 'N√£o informado'}<br>
                    Telefone: ${cliente.tel || 'N√£o informado'}<br>
                    E-mail: ${cliente.email || 'N√£o informado'}</p>
                </div>

                <div class="contrato-section">
                    <h3>2. Objeto do Contrato</h3>
                    <p>${servico}</p>
                </div>

                <div class="contrato-section">
                    <h3>3. Valor e Forma de Pagamento</h3>
                    <p><strong>Valor Total:</strong> R$ ${valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                    <p><strong>Forma de Pagamento:</strong> ${pagamento || 'A combinar'}</p>
                </div>

                <div class="contrato-section">
                    <h3>4. Prazo de Execu√ß√£o</h3>
                    <p><strong>Data de Entrega/Instala√ß√£o:</strong> ${entrega ? new Date(entrega).toLocaleDateString('pt-BR') : 'A definir'}</p>
                </div>

                <div class="contrato-section">
                    <h3>5. Garantia</h3>
                    <p>A CONTRATADA garante a qualidade dos materiais e m√£o de obra pelo per√≠odo de <strong>12 (doze) meses</strong> a partir da data de conclus√£o do servi√ßo, exceto em casos de mau uso ou danos causados pelo CONTRATANTE.</p>
                </div>

                <div class="contrato-section">
                    <h3>6. Responsabilidades</h3>
                    <p><strong>CONTRATADA:</strong> Executar os servi√ßos conforme especificado, utilizando materiais de qualidade e m√£o de obra especializada.</p>
                    <p><strong>CONTRATANTE:</strong> Efetuar os pagamentos nas datas acordadas e fornecer as condi√ß√µes necess√°rias para execu√ß√£o dos servi√ßos.</p>
                </div>

                ${obs ? `
                <div class="contrato-section">
                    <h3>7. Observa√ß√µes Adicionais</h3>
                    <p>${obs}</p>
                </div>
                ` : ''}

                <div class="contrato-section">
                    <p style="text-align: justify; font-size: 0.875rem;">
                    As partes, por estarem justas e contratadas, assinam o presente contrato em duas vias de igual teor e forma, 
                    para que produza seus efeitos legais.
                    </p>
                    <p style="text-align: right; margin-top: 2rem;"><strong>Data:</strong> ${hoje}</p>
                </div>

                <div class="assinatura-box">
                    <div>
                        <div class="assinatura-line">SD M√ìVEIS</div>
                        <div style="font-size: 0.875rem; color: var(--text-sub); margin-top: 0.5rem;">CONTRATADA</div>
                    </div>
                    <div>
                        <div class="assinatura-line">${cliente.nome}</div>
                        <div style="font-size: 0.875rem; color: var(--text-sub); margin-top: 0.5rem;">CONTRATANTE</div>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('contrato-view').style.display = 'block';
        document.getElementById('contrato-view').scrollIntoView({behavior: 'smooth'});
    }

    function gerarContratosPDF() {
        const doc = new jsPDF();
        const content = document.querySelector('.contrato-preview');
        
        // Simplificado - em produ√ß√£o usar html2canvas + jsPDF
        doc.setFontSize(16);
        doc.text("SD M√ìVEIS - CONTRATO", 105, 20, {align: 'center'});
        doc.setFontSize(10);
        
        const texto = content.innerText;
        const linhas = doc.splitTextToSize(texto, 180);
        doc.text(linhas, 15, 40);
        
        doc.save(`Contrato_SD_Moveis_${new Date().toISOString().split('T')[0]}.pdf`);
    }

    // PORTFOLIO
    function addItem(tipo) {
        const t = prompt("T√≠tulo:");
        if(!t) return;
        
        const d = prompt("Descri√ß√£o:");
        
        if(tipo === 'portfolio') {
            const img = prompt("URL da Imagem:");
            db.portfolio.push({t, d, img});
        } else {
            const dica = prompt("Categoria (ex: GARANTIA, MANUTEN√á√ÉO):");
            db.manual.push({t, d, dica});
        }
        save();
    }

    // FERRAMENTAS
    function calcMDF() {
        const m = parseFloat(document.getElementById('m-calc').value) || 0;
        const chapas = Math.ceil(m / 1.5);
        document.getElementById('res-mdf').innerText = m ? `üìä Estimativa: ${chapas} chapas de MDF` : '';
    }

    function gerarOrcamento() {
        const c = document.getElementById('orc-cliente').value;
        const i = document.getElementById('orc-itens').value;
        const v = parseFloat(document.getElementById('orc-valor').value);
        
        if(!c || !i || !v) {
            alert("‚ö†Ô∏è Preencha todos os campos!");
            return;
        }
        
        const txt = `*OR√áAMENTO SD M√ìVEIS* üõ†Ô∏è\n\n*Cliente:* ${c}\n*Servi√ßos:*\n${i}\n\n*Valor Total:* R$ ${v.toLocaleString('pt-BR')}\n\n_Qualidade que transforma seu lar!_ ‚ú®`;
        navigator.clipboard.writeText(txt);
        alert("‚úÖ Or√ßamento copiado! Cole no WhatsApp.");
    }

    function gerarPDF(t, d) {
        const doc = new jsPDF();
        doc.setFontSize(16);
        doc.text("SD M√ìVEIS - MANUAL", 10, 20);
        doc.setFontSize(12);
        doc.text(t, 10, 35);
        doc.setFontSize(10);
        doc.text(d, 10, 50, {maxWidth: 180});
        doc.save(`SD_${t.replace(/\s/g, '_')}.pdf`);
    }

    function exportarBackup() {
        const blob = new Blob([JSON.stringify(db, null, 2)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `BACKUP_SD_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        alert("‚úÖ Backup salvo!");
    }

    // CHARTS
    function initCharts() {
        charts.progresso = new Chart(document.getElementById('chartProgresso'), {
            type: 'doughnut',
            data: {
                labels: ['0-25%', '25-50%', '50-75%', '75-100%'],
                datasets: [{
                    data: [0, 0, 0, 0],
                    backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#10b981']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        charts.faturamento = new Chart(document.getElementById('chartFaturamento'), {
            type: 'bar',
            data: {
                labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                datasets: [{
                    label: 'Faturamento',
                    data: [0, 0, 0, 0, 0, 0],
                    backgroundColor: '#3b82f6'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        charts.status = new Chart(document.getElementById('chartStatus'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Progresso M√©dio',
                    data: [],
                    borderColor: '#D4AF37',
                    backgroundColor: 'rgba(212, 175, 55, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: { beginAtZero: true, max: 100 }
                }
            }
        });
    }

    function updateCharts() {
        document.getElementById('stat-projetos').textContent = db.projetos.length;
        document.getElementById('stat-faturamento').textContent = 'R$ ' + db.projetos.reduce((acc, p) => acc + p.valor, 0).toLocaleString('pt-BR');
        
        const prazosProximos = db.projetos.filter(p => {
            if(!p.prazo) return false;
            const diff = (new Date(p.prazo) - new Date()) / (1000*60*60*24);
            return diff >= 0 && diff < 7;
        }).length;
        document.getElementById('stat-prazos').textContent = prazosProximos;
        document.getElementById('stat-clientes').textContent = db.clientes.length;

        const ranges = [0, 0, 0, 0];
        db.projetos.forEach(p => {
            if(p.progresso <= 25) ranges[0]++;
            else if(p.progresso <= 50) ranges[1]++;
            else if(p.progresso <= 75) ranges[2]++;
            else ranges[3]++;
        });
        charts.progresso.data.datasets[0].data = ranges;
        charts.progresso.update();

        const ultimos = db.projetos.slice(-10);
        charts.status.data.labels = ultimos.map((p, i) => `P${i+1}`);
        charts.status.data.datasets[0].data = ultimos.map(p => p.progresso);
        charts.status.update();
    }

    // RENDER
    function render() {
        // Projetos
        document.getElementById('lista-projects').innerHTML = db.projetos.map((p, i) => `
            <div class="card" style="border-left: 6px solid ${calcPrazoCor(p.prazo)}">
                <div style="display:flex; justify-content:space-between; align-items: start; margin-bottom: 0.5rem;">
                    <div>
                        <strong style="font-size: 1.1rem;">${p.cliente}</strong>
                        ${getPrazoStatus(p.prazo)}
                    </div>
                    <small style="color: var(--text-sub);">üìÖ ${p.prazo || 'Sem prazo'}</small>
                </div>
                <p style="font-size:0.875rem; color:var(--text-sub); margin: 0.5rem 0;">${p.servico}</p>
                <p style="font-size:0.875rem; color:var(--success); font-weight: 600; margin: 0.5rem 0;">üí∞ R$ ${p.valor.toLocaleString('pt-BR')}</p>
                
                <div class="progress-bg">
                    <div class="progress-fill" style="width:${p.progresso}%"></div>
                </div>
                <div style="text-align: center; font-size: 0.75rem; color: var(--text-sub); margin-top: -8px;">${p.progresso}% conclu√≠do</div>
                
                <div class="checklist">
                    <label><input type="checkbox" ${p.check[0]?'checked':''} onclick="db.projetos[${i}].check[0]=!db.projetos[${i}].check[0]; save()"> ‚úÇÔ∏è Corte</label>
                    <label><input type="checkbox" ${p.check[1]?'checked':''} onclick="db.projetos[${i}].check[1]=!db.projetos[${i}].check[1]; save()"> üìè Fita</label>
                    <label><input type="checkbox" ${p.check[2]?'checked':''} onclick="db.projetos[${i}].check[2]=!db.projetos[${i}].check[2]; save()"> üî® Montagem</label>
                </div>
                
                <div style="margin-top:12px; display:flex; gap: 8px; justify-content: space-between;">
                    <button class="btn-outline" onclick="db.projetos[${i}].progresso=Math.min(100,db.projetos[${i}].progresso+10); save()">‚ûï Avan√ßar</button>
                    <button class="btn-outline" onclick="db.projetos[${i}].progresso=Math.max(0,db.projetos[${i}].progresso-10); save()">‚ûñ Voltar</button>
                    <button class="btn-outline" style="color:var(--danger)" onclick="if(confirm('Deletar projeto?')) {db.projetos.splice(${i},1); save();}">üóëÔ∏è</button>
                </div>
            </div>
        `).join('') || '<p style="color: var(--text-sub); text-align: center; padding: 2rem;">Nenhum projeto ativo. Clique em "+ Novo Projeto" para come√ßar!</p>';

        // Clientes
        document.getElementById('lista-clientes').innerHTML = db.clientes.map((c, i) => {
            const projs = db.projetos.filter(p => p.cliente === c.nome);
            const total = projs.reduce((acc, p) => acc + p.valor, 0);
            
            return `
                <div class="cliente-card" onclick="verCliente(${i})">
                    <div class="cliente-header">
                        <div class="cliente-info">
                            <h3>${c.nome}</h3>
                            <div class="meta">
                                ${c.tel ? `üìû ${c.tel}` : ''} 
                                ${c.email ? `‚Ä¢ üìß ${c.email}` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="cliente-stats">
                        <div class="cliente-stat">
                            <div class="label">Projetos</div>
                            <div class="value">${projs.length}</div>
                        </div>
                        <div class="cliente-stat">
                            <div class="label">Total</div>
                            <div class="value" style="color: var(--success);">R$ ${total.toLocaleString('pt-BR')}</div>
                        </div>
                    </div>
                </div>
            `;
        }).join('') || '<p style="color: var(--text-sub); text-align: center; padding: 2rem;">Nenhum cliente cadastrado ainda.</p>';

        // Portf√≥lio
        document.getElementById('grid-portfolio').innerHTML = db.portfolio.map((p, i) => `
            <div class="card" style="padding:0">
                <img src="${p.img}" style="width:100%; height:200px; object-fit:cover;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22200%22%3E%3Crect fill=%22%23E5E7EB%22 width=%22400%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%236B7280%22 font-family=%22sans-serif%22%3ESem Imagem%3C/text%3E%3C/svg%3E'">
                <div style="padding:1.25rem">
                    <span style="color:var(--gold); font-size:0.7rem; font-weight:700; text-transform: uppercase;">SD M√ìVEIS PORTF√ìLIO</span>
                    <h4 style="margin:0.5rem 0;">${p.t}</h4>
                    <p style="font-size:0.875rem; color:var(--text-sub); margin: 0.5rem 0;">üìù ${p.d}</p>
                    <button class="btn-outline" style="color:var(--danger); margin-top: 0.75rem;" onclick="event.stopPropagation(); if(confirm('Deletar?')) {db.portfolio.splice(${i},1); save();}">üóëÔ∏è Remover</button>
                </div>
            </div>
        `).join('') || '<p style="color: var(--text-sub); text-align: center; padding: 2rem;">Nenhuma foto no portf√≥lio ainda.</p>';

        // Manual
        document.getElementById('lista-manual').innerHTML = db.manual.map((m, i) => `
            <div class="manual-item">
                <div class="manual-info">
                    <span>${m.dica || 'DOCUMENTA√á√ÉO'}</span>
                    <h4 style="margin: 0.5rem 0;">${m.t}</h4>
                    <p style="font-size: 0.875rem; color: var(--text-sub); margin: 0;">${m.d}</p>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn-outline" onclick="gerarPDF('${m.t}','${m.d}')">üìÑ PDF</button>
                    <button class="btn-outline" style="color:var(--danger)" onclick="if(confirm('Deletar?')) {db.manual.splice(${i},1); save();}">üóëÔ∏è</button>
                </div>
            </div>
        `).join('') || '<p style="color: var(--text-sub); text-align: center; padding: 2rem;">Nenhum manual cadastrado.</p>';

        // Financeiro
        const total = db.projetos.reduce((acc, p) => acc + p.valor, 0);
        document.getElementById('total-vendas').innerText = `R$ ${total.toLocaleString('pt-BR')}`;
    }

    render();
</script>
</body>
</html>
